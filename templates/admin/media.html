{% extends 'admin/admin-base.html' %}
{% set active_page = 'media' %}

{% block title %}Media Library{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin-media.css') }}">
{% endblock %}

{% block content %}
<div class="media-header">
  <h1>
    <i class="fas fa-photo-film"></i>
    Media Library
  </h1>
  <div class="header-actions">
    <div class="search-box">
      <i class="fas fa-search"></i>
      <input type="text" id="mediaSearch" placeholder="Search files..." onkeyup="filterMedia()">
    </div>
    <label class="btn btn-primary" for="mediaInput">
      <i class="fas fa-upload"></i> Upload Files
    </label>
    <input id="mediaInput" type="file" multiple style="display:none" onchange="handleUpload(event)">
  </div>
  <!-- Alert container now managed globally by alerts.js -->
  <div class="dropzone" id="dropzone">
    <i class="fas fa-cloud-upload-alt"></i>
    <p>Drag & drop files here or click Upload</p>
  </div>
</div>

<div class="admin-card">
  <div class="view-toggle">
    <button id="viewGridBtn" class="btn-small active" onclick="setView('grid')"><i class="fas fa-th"></i> Grid</button>
    <button id="viewListBtn" class="btn-small" onclick="setView('list')"><i class="fas fa-list"></i> List</button>
  </div>
  <div id="media-container">
    <div class="loading-state">
      <i class="fas fa-circle-notch fa-spin"></i>
      <p>Loading media...</p>
    </div>
  </div>
  <div class="legend">
    <small><i class="fas fa-info-circle"></i> Tip: Click Copy Link to copy the public URL. Download saves the file.</small>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2><i class="fas fa-exclamation-triangle"></i> Confirm Deletion</h2>
      <span class="close" onclick="closeDeleteModal()">&times;</span>
    </div>
    <div class="modal-body">
      <p>Are you sure you want to delete this file?</p>
      <p><strong id="deleteFileName"></strong></p>
      <p style="color: #e74c3c; margin-top: 1rem;"><i class="fas fa-exclamation-circle"></i> This action cannot be undone!</p>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeDeleteModal()">Cancel</button>
      <button class="btn btn-delete" onclick="confirmDelete()"><i class="fas fa-trash"></i> Delete File</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  let allMedia = [];
  let filteredMedia = [];
  let currentView = 'grid';

  function bytesToSize(bytes) {
    if (bytes === 0 || bytes === undefined || bytes === null) return '0 B';
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(1024));
    return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + sizes[i];
  }

  function isImage(mime) { return mime && mime.startsWith('image/'); }
  function isVideo(mime) { return mime && mime.startsWith('video/'); }
  function isAudio(mime) { return mime && mime.startsWith('audio/'); }

  function setView(view) {
    currentView = view;
    const gridBtn = document.getElementById('viewGridBtn');
    const listBtn = document.getElementById('viewListBtn');
    if (gridBtn && listBtn) {
      if (view === 'grid') { gridBtn.classList.add('active'); listBtn.classList.remove('active'); }
      else { listBtn.classList.add('active'); gridBtn.classList.remove('active'); }
    }
    displayMedia();
  }

  function showMessage(message, type = 'info') {
    showAlert(message, { type: type });
  }

  async function loadMedia() {
    try {
      const res = await apiFetch('/api/admin/media');
      if (!res.ok) throw new Error('Failed to load media');
      allMedia = await res.json();
      filteredMedia = [...allMedia];
      displayMedia();
    } catch (e) {
      showMessage('Error loading media', 'error');
    }
  }

  function filterMedia() {
    const term = document.getElementById('mediaSearch').value.toLowerCase();
    filteredMedia = allMedia.filter(f =>
      (f.name && f.name.toLowerCase().includes(term)) ||
      (f.mime && f.mime.toLowerCase().includes(term)) ||
      (f.path && f.path.toLowerCase().includes(term))
    );
    displayMedia();
  }

  function mediaItemHTML(file) {
    const preview = isImage(file.mime)
      ? `<img src="${API_BASE_URL}${file.url}" alt="${file.name}" class="media-thumb">`
      : isVideo(file.mime)
        ? `<video class="media-thumb" src="${API_BASE_URL}${file.url}" muted></video>`
        : isAudio(file.mime)
          ? `<div class="media-audio"><i class="fas fa-music"></i></div>`
          : `<div class="media-icon"><i class="fas fa-file"></i></div>`;
    
    const fileId = file.path.replace(/[^a-zA-Z0-9]/g, '_');
    
    return `
      <div class="media-card">
        <div class="media-preview">${preview}</div>
        <div class="media-info">
          <div class="media-name" title="${file.name}">${file.name}</div>
          <div class="media-meta"><i class="fas fa-file-alt"></i> ${file.mime || 'Unknown'} â€¢ ${bytesToSize(file.size)}</div>
        </div>
        <div class="media-actions">
          <div class="action-menu">
            <button class="btn-small btn-actions" onclick="toggleMediaActions(event, '${fileId}')">
              <i class="fas fa-ellipsis-h"></i> Actions
            </button>
            <div class="actions-dropdown" id="media-actions-${fileId}">
              <button class="dropdown-item" onclick="openInNewTab('${file.url}')">
                <i class="fas fa-external-link-alt"></i> Open
              </button>
              <button class="dropdown-item" onclick="copyLink('${file.url}')">
                <i class="fas fa-link"></i> Copy Link
              </button>
              <a class="dropdown-item" href="${API_BASE_URL}${file.url}" download>
                <i class="fas fa-download"></i> Download
              </a>
              <button class="dropdown-item danger" onclick="deleteFile('${file.path}', '${file.name}')">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function mediaRowHTML(file) {
    const fileId = file.path.replace(/[^a-zA-Z0-9]/g, '_');
    
    return `
      <tr>
        <td class="col-name">
          <div class="name-cell">
            <i class="fas fa-file"></i>
            <span title="${file.name}">${file.name}</span>
          </div>
        </td>
        <td>${file.mime || 'Unknown'}</td>
        <td>${bytesToSize(file.size)}</td>
        <td class="row-actions">
          <div class="action-menu">
            <button class="btn-small btn-actions" onclick="toggleMediaActions(event, '${fileId}')">
              <i class="fas fa-ellipsis-h"></i> Actions
            </button>
            <div class="actions-dropdown" id="media-actions-${fileId}">
              <button class="dropdown-item" onclick="openInNewTab('${file.url}')">
                <i class="fas fa-external-link-alt"></i> Open
              </button>
              <button class="dropdown-item" onclick="copyLink('${file.url}')">
                <i class="fas fa-link"></i> Copy Link
              </button>
              <a class="dropdown-item" href="${API_BASE_URL}${file.url}" download>
                <i class="fas fa-download"></i> Download
              </a>
              <button class="dropdown-item danger" onclick="deleteFile('${file.path}', '${file.name}')">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          </div>
        </td>
      </tr>
    `;
  }

  function displayMedia() {
    const container = document.getElementById('media-container');
    if (filteredMedia.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-photo-film"></i>
          <p>No media files found. Upload your first file!</p>
        </div>
      `;
      return;
    }

    if (currentView === 'grid') {
      let html = '<div class="media-grid">';
      filteredMedia.forEach(f => { html += mediaItemHTML(f); });
      html += '</div>';
      container.innerHTML = html;
    } else {
      let html = `
        <div class="table-responsive">
          <table class="media-table">
            <thead>
              <tr>
                <th>Name</th><th>Type</th><th>Size</th><th>Actions</th>
              </tr>
            </thead>
            <tbody>
      `;
      filteredMedia.forEach(f => { html += mediaRowHTML(f); });
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }
  }

  function openInNewTab(url) {
    window.open(`${API_BASE_URL}${url}`, '_blank');
  }

  async function copyLink(url) {
    try {
      await navigator.clipboard.writeText(`${API_BASE_URL}${url}`);
      showMessage('Link copied to clipboard', 'success');
    } catch {
      showMessage('Failed to copy link', 'error');
    }
  }

  async function handleUpload(e) {
    const files = e.target.files;
    if (!files || files.length === 0) return;
    const form = new FormData();
    Array.from(files).forEach(f => form.append('files', f));
    try {
      const res = await apiFetch('/api/admin/media/upload', { method: 'POST', body: form });
      const result = await res.json();
      if (!res.ok) throw new Error(result.error || 'Upload failed');
      showMessage(`Uploaded ${result.files.length} file(s)`, 'success');
      await loadMedia();
    } catch (err) {
      showMessage(err.message || 'Upload error', 'error');
    } finally {
      e.target.value = '';
    }
  }

  // Drag and drop
  const dropzone = document.getElementById('dropzone');
  dropzone.addEventListener('dragover', (ev) => { ev.preventDefault(); dropzone.classList.add('drag'); });
  dropzone.addEventListener('dragleave', () => dropzone.classList.remove('drag'));
  dropzone.addEventListener('drop', async (ev) => {
    ev.preventDefault(); dropzone.classList.remove('drag');
    const items = ev.dataTransfer.files;
    if (!items || items.length === 0) return;
    const form = new FormData();
    Array.from(items).forEach(f => form.append('files', f));
    try {
      const res = await apiFetch('/api/admin/media/upload', { method: 'POST', body: form });
      const result = await res.json();
      if (!res.ok) throw new Error(result.error || 'Upload failed');
      showMessage(`Uploaded ${result.files.length} file(s)`, 'success');
      await loadMedia();
    } catch (err) {
      showMessage(err.message || 'Upload error', 'error');
    }
  });

  // Toggle actions dropdown
  function toggleMediaActions(event, fileId) {
    event.stopPropagation();
    const dropdown = document.getElementById(`media-actions-${fileId}`);
    const allDropdowns = document.querySelectorAll('.actions-dropdown');
    
    // Close all other dropdowns
    allDropdowns.forEach(dd => {
      if (dd.id !== `media-actions-${fileId}`) {
        dd.classList.remove('show');
      }
    });
    
    // Toggle current dropdown
    dropdown.classList.toggle('show');
  }

  // Close dropdowns when clicking outside
  document.addEventListener('click', function(event) {
    if (!event.target.closest('.action-menu')) {
      document.querySelectorAll('.actions-dropdown').forEach(dd => {
        dd.classList.remove('show');
      });
    }
  });

  // Delete functionality
  let fileToDelete = null;

  function deleteFile(filePath, fileName) {
    fileToDelete = filePath;
    document.getElementById('deleteFileName').textContent = fileName;
    document.getElementById('deleteModal').style.display = 'block';
    
    // Close any open dropdowns
    document.querySelectorAll('.actions-dropdown').forEach(dd => {
      dd.classList.remove('show');
    });
  }

  function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
    fileToDelete = null;
  }

  async function confirmDelete() {
    if (!fileToDelete) return;

    try {
      const res = await apiFetch('/api/admin/media/delete', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ path: fileToDelete })
      });
      
      const result = await res.json();
      
      if (!res.ok) throw new Error(result.error || 'Delete failed');
      
      showMessage('File deleted successfully', 'success');
      closeDeleteModal();
      await loadMedia();
    } catch (err) {
      showMessage(err.message || 'Delete error', 'error');
    }
  }

  // Close modal when clicking outside
  window.onclick = function(event) {
    const modal = document.getElementById('deleteModal');
    if (event.target === modal) {
      closeDeleteModal();
    }
  }

  document.addEventListener('DOMContentLoaded', loadMedia);
</script>
{% endblock %}


